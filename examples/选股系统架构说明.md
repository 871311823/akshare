# 周线MACD选股系统 - 架构与数据来源说明

## 一、系统概述

**项目名称**: 周线 MACD 零轴回踩起爆选股器  
**技术栈**: Python + Flask + AKShare  
**部署位置**: `E:\code\akshare\examples\stock_screener_web.py`

---

## 二、数据来源

### 2.1 股票基础数据

#### 接口1: 获取A股列表
```python
import akshare as ak
stocks = ak.stock_info_a_code_name()
```
- **返回字段**: 代码、名称
- **数据源**: AKShare内置接口
- **用途**: 获取所有A股股票代码和名称

---

### 2.2 股票历史行情数据

#### 接口2: 东方财富周线数据 (优先使用)
```python
df = ak.stock_zh_a_hist(
    symbol="000001",           # 股票代码
    period="weekly",           # 周线
    start_date="20210101",     # 开始日期
    end_date="20240101",       # 结束日期
    adjust="qfq",              # 前复权
    timeout=10                 # 超时时间
)
```
- **数据源**: 东方财富网 (http://data.eastmoney.com)
- **返回字段**: 日期、开盘、最高、最低、收盘、成交量
- **优点**: 直接提供周线数据,速度快
- **缺点**: 某些网络环境可能被限制

#### 接口3: 腾讯日线数据 (兜底方案)
```python
df_daily = ak.stock_zh_a_hist_tx(
    symbol="sz000001",         # 股票代码(需加sh/sz前缀)
    start_date="20210101",     # 开始日期
    end_date="20240101",       # 结束日期
    adjust="qfq",              # 前复权
    timeout=10                 # 超时时间
)
```
- **数据源**: 腾讯财经
- **返回字段**: date, open, high, low, close, amount (英文字段)
- **使用场景**: 当东方财富接口不可用时自动切换
- **处理方式**: 将日线数据聚合成周线
  ```python
  df_weekly = df_daily.resample("W-FRI").agg({
      "open": "first",    # 周一开盘价
      "high": "max",      # 周内最高价
      "low": "min",       # 周内最低价
      "close": "last",    # 周五收盘价
      "amount": "sum"     # 周成交量总和
  })
  ```

---

## 三、技术指标计算

### 3.1 MACD指标
```python
def calculate_macd(df, fast=12, slow=26, signal=9):
    close = df['收盘']
    ema_fast = close.ewm(span=fast, adjust=False).mean()
    ema_slow = close.ewm(span=slow, adjust=False).mean()
    df['DIF'] = ema_fast - ema_slow
    df['DEA'] = df['DIF'].ewm(span=signal, adjust=False).mean()
    df['MACD柱'] = 2 * (df['DIF'] - df['DEA'])
    return df
```
- **参数**: 快线12, 慢线26, 信号线9
- **计算指标**: DIF, DEA, MACD柱

### 3.2 均线指标
```python
df['MA55'] = df['收盘'].rolling(window=55).mean()
df['MA20'] = df['收盘'].rolling(window=20).mean()
```
- **MA55**: 55周均线 (约1年)
- **MA20**: 20周均线 (约5个月)

---

## 四、选股条件 (默认模式)

### 4.1 严格模式
```python
{
    'ma_min': 0,           # MA55偏离度下限 0%
    'ma_max': 0.08,        # MA55偏离度上限 8%
    'history_dea': 0.3,    # 历史DEA最低要求
    'pullback': 0.3,       # 当前DEA需小于历史的30%
    'dea_min': 0,          # DEA下限
    'dea_max': 0.5,        # DEA上限
}
```

### 4.2 默认模式
```python
{
    'ma_min': -0.05,       # 允许略微跌穿MA55 -5%
    'ma_max': 0.10,        # MA55偏离度上限 10%
    'history_dea': 0.1,    # 历史DEA最低要求
    'pullback': 0.5,       # 当前DEA需小于历史的50%
    'dea_min': 0,          # DEA下限
    'dea_max': 1.0,        # DEA上限
}
```

### 4.3 宽松模式
```python
{
    'ma_min': -0.10,       # 允许跌穿MA55 10%
    'ma_max': 0.20,        # MA55偏离度上限 20%
    'history_dea': 0.05,   # 历史DEA最低要求
    'pullback': 0.7,       # 当前DEA需小于历史的70%
    'dea_min': -0.2,       # 允许负值
    'dea_max': 1.5,        # DEA上限
}
```

---

## 五、筛选逻辑

### 5.1 条件1: 均线支撑
```python
deviation = (close - ma55) / ma55
if deviation < ma_min or deviation >= ma_max:
    return None  # 不符合
```
- **说明**: 股价需要在MA55附近,不能太远也不能跌太多

### 5.2 条件2: 大趋势回调
```python
max_dea_100w = df.tail(100)['DEA'].max()  # 100周历史最高DEA
if max_dea_100w <= history_dea:
    return None  # 历史高度不够
if dea >= pullback * max_dea_100w:
    return None  # 回调不充分
```
- **说明**: 要求之前有过大牛市,现在回调到位

### 5.3 条件3: 零轴企稳
```python
if dea <= dea_min or dea >= dea_max:
    return None  # DEA不在零轴附近
```
- **说明**: DEA要在零轴附近(0~1之间)

### 5.4 条件4: 趋势反转
```python
is_golden = dif > dea  # 金叉
is_green_shrink = macd > prev_macd and macd < 0  # 绿柱缩短
```
- **金叉**: DIF上穿DEA
- **即将金叉**: MACD绿柱逐渐缩短

---

## 六、Web界面

### 6.1 技术栈
- **后端**: Flask
- **前端**: 原生HTML + JavaScript (无框架)
- **通信**: AJAX轮询

### 6.2 API接口

#### 启动筛选
```http
GET /start?ratio=0.05&mode=default&golden=0
```
- **ratio**: 抽样比例 (0.01=1%, 0.05=5%, 0.10=10%, etc.)
- **mode**: 筛选模式 (strict/default/loose)
- **golden**: 仅金叉 (0=包含即将金叉, 1=仅已金叉)

#### 获取状态
```http
GET /status
```
- **返回**: 
  ```json
  {
    "status": "running",
    "progress": 50,
    "total": 100,
    "current_stock": "000001 平安银行",
    "data_source": "东方财富 (stock_zh_a_hist)",
    "results": [...],
    "stats": {"success": 45, "failed": 5, "matched": 3},
    "message": "筛选中..."
  }
  ```

---

## 七、启动脚本

### 7.1 Windows启动
```bash
# 文件: scripts/start_screener.bat
cd E:\code\akshare
python examples\stock_screener_web.py
```

### 7.2 Linux/Mac启动
```bash
# 文件: scripts/start_screener.sh
#!/bin/bash
cd /path/to/akshare
python examples/stock_screener_web.py
```

### 7.3 环境变量配置
```bash
# 默认值
HOST=127.0.0.1
PORT=5000
```

---

## 八、数据流程图

```
用户访问 http://127.0.0.1:5000
    ↓
选择筛选模式 + 抽样比例
    ↓
点击"开始筛选"
    ↓
后端获取A股列表 (ak.stock_info_a_code_name)
    ↓
过滤: 去除ST、退市、只保留主板/创业板/科创板
    ↓
抽样 (可选)
    ↓
遍历每只股票:
    ├─ 尝试东方财富周线数据 (ak.stock_zh_a_hist)
    ├─ 失败则切换腾讯日线 (ak.stock_zh_a_hist_tx) + 聚合
    ├─ 计算MACD指标
    ├─ 计算MA55均线
    ├─ 应用5个筛选条件
    └─ 符合条件则保存结果
    ↓
按MA55偏离度排序
    ↓
返回结果到前端展示
```

---

## 九、性能优化

### 9.1 数据源健康检测
```python
DATA_SOURCE_HEALTH = {
    "eastmoney_ok": None  # None=未知, True=可用, False=不可用
}
```
- 如果东方财富接口首次失败,后续自动跳过,避免重复尝试

### 9.2 请求频率控制
```python
time.sleep(0.1)  # 每只股票延迟100ms
```
- 避免请求过快被封IP

### 9.3 超时设置
```python
timeout=10  # 单个请求超时10秒
```

---

## 十、依赖清单

```txt
akshare>=1.12.0
flask>=2.3.0
pandas>=2.0.0
tqdm>=4.65.0
```

---

## 十一、文件结构

```
E:\code\akshare\
├── akshare/                    # AKShare库源码
├── examples/                   # 示例应用
│   ├── stock_screener_web.py           # Web版选股器 ⭐
│   ├── stock_screener_monthly_macd.py  # 命令行版选股器
│   ├── analyze_stock.py
│   ├── diagnose_screener.py
│   └── test_data_sources.py
├── scripts/                    # 启动脚本
│   ├── start_screener.bat
│   ├── start_screener.sh
│   ├── stop_screener.bat
│   └── stop_screener.sh
├── docs/                       # 文档
├── tests/                      # 测试
└── README.md
```

---

## 十二、参考锚点股票

**牧原股份 (002714)**
- MA偏离度: 1.84%
- DEA: 0.87
- 历史DEA: 3.33
- 回落比: 26%

该股票符合默认模式的所有条件,作为选股参数调优的参考标准。

---

## 十三、常见问题

### Q1: 东方财富接口连不上怎么办?
**A**: 系统会自动切换到腾讯数据源,无需手动干预。

### Q2: 筛选速度很慢?
**A**: 可以:
1. 降低抽样比例 (改为1%或5%)
2. 检查网络连接
3. 增加 `time.sleep()` 延迟避免被限速

### Q3: 如何添加新的筛选条件?
**A**: 修改 `screen_stock()` 函数,添加新的判断逻辑。

---

## 十四、联系方式

- **项目地址**: https://github.com/akfamily/akshare
- **文档**: https://akshare.akfamily.xyz/

---

**最后更新**: 2026-02-04  
**版本**: v1.0
